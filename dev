#!/bin/bash

# Load env vars from .env
set -a
source .env
set +a

# Resolve config paths
DATA_PATH="${DAYLIGHT_BASE_PATH}/data"
ENV_NAME="${DAYLIGHT_ENV:-$(hostname)}"
CONFIG_FILE="${DATA_PATH}/system/system-local.${ENV_NAME}.yml"

# Read ports from config (fallback to defaults if not found)
if [[ -f "$CONFIG_FILE" ]]; then
    PRIMARY_PORT=$(grep -A1 '^server:' "$CONFIG_FILE" | grep 'port:' | awk '{print $2}')
    SECONDARY_PORT=$(grep -A1 '^webhook:' "$CONFIG_FILE" | grep 'port:' | awk '{print $2}')
    PRIMARY_PORT=${PRIMARY_PORT:-3111}
    SECONDARY_PORT=${SECONDARY_PORT:-3119}
else
    echo "Warning: Config file not found: $CONFIG_FILE"
    PRIMARY_PORT=3111
    SECONDARY_PORT=3119
fi

echo "Using ports from $ENV_NAME config: primary=$PRIMARY_PORT, secondary=$SECONDARY_PORT"

# Kill any process using configured ports
lsof -ti:$PRIMARY_PORT 2>/dev/null | xargs kill -9 2>/dev/null || true
lsof -ti:$SECONDARY_PORT 2>/dev/null | xargs kill -9 2>/dev/null || true

## clear dev.log
> ./dev.log

# Check if --background flag is provided
if [[ "$1" == "--background" ]]; then
    npm run dev > /dev/null 2>&1 &
    PID=$!
    echo "Dev server started in background with PID: $PID"
    echo "Check logs at ./dev.log"
    echo $PID
else
    npm run dev
fi
