# Social Features Design

> Federated social sharing between DaylightStation households via Nostr

**Last Updated:** 2026-02-02
**Status:** Design Complete, Ready for Implementation
**Dependencies:** Gatekeeper domain, Licensing/Nostr infrastructure

---

## Overview

DaylightStation Social enables sharing between households running separate DaylightStation instances. Built on Nostr for federation, with strong privacy controls via Gatekeeper integration.

**Two distinct scopes:**

| Scope | Transport | Encryption | Example |
|-------|-----------|------------|---------|
| **Household** | Local DB only | None needed | Kid's chores, internal notes |
| **External** | Nostr relays | E2E encrypted (NIP-44) | Workouts shared with cousins |

**Security model:** Zero-trust network. Relays are untrusted infrastructure. Security comes from cryptography (signatures for authenticity, encryption for confidentiality), not network perimeters.

---

## Use Cases

### Family Clusters (Primary)

Multiple DaylightStation instances run by family members share activity bidirectionally:

- Cousins see each other's workout completions
- Grandparents see photo albums from multiple households
- Extended family shares recipes and meal ideas

### Household-Internal Social

Users within the same household share without any external network involvement:

- Kid completes chores → Parents see it in household feed
- Family announcements visible to all household members
- Private posts for personal journaling

### Activity Sharing

Auto-generated posts from system activity:

- "Kevin completed a 30-minute cycling workout"
- "Sarah watched Severance S2E03"
- "The Kern Household tried a new pasta recipe"

---

## Visibility Model

Standard social media visibility tiers:

| Level | Audience | Transport |
|-------|----------|-----------|
| **Private** | Only the poster | Local only |
| **Household** | All users on this box (role-filtered) | Local only |
| **Circle(s)** | Named groups on other boxes | Nostr (encrypted) |
| **All Connections** | Everyone mutually connected | Nostr (encrypted) |
| **Public** | Anyone on Nostr | Nostr (unencrypted) |

### Household Role Filtering

Household-level posts inherit Gatekeeper governance:

- Parents see all household posts
- Kids see age-appropriate content only
- Same rules as existing content governance

### Device Visibility

Devices without active user sessions (kitchen kiosk, garage display):

- **Viewing:** Can display household-level posts (no private posts)
- **Posting:** Falls back to "Household" as author, device captured as metadata

---

## Author Resolution

Posts are attributed following this chain:

```
1. Explicit login     → Use logged-in user
2. Contextual owner   → Chore assigned to KidA? KidA is author
3. Fallback           → "Household" with device as metadata
```

Example: Chore assigned to KidA gets marked complete on kitchen kiosk → Post attributed to KidA (not "Kitchen Kiosk" or "Household").

---

## Post Creation Model

**Auto-generated by policy with override:**

1. System detects activity (workout complete, chore done, media watched)
2. SharingPolicy evaluated → determines if post should be created and visibility
3. Draft post created
4. User can override (edit, change visibility, cancel) or auto-publish based on preference

**Per-category settings:**

| Category | Options |
|----------|---------|
| Workouts | Auto-share / Ask each time / Never |
| Watch activity | Auto-share / Ask each time / Never |
| Photos | Manual only / Ask each time |
| Chores | Household only / Never |
| Freeform | Manual only |

---

## Content Types

| Type | Kind | Description |
|------|------|-------------|
| Activity | 31337 | General activity summary |
| Media | 31338 | Watch/listen recommendations, ratings |
| Recipe | 31339 | Meal and recipe sharing |
| Fitness | 31340 | Workout logs and summaries |
| Photo | 31341 | Photo albums and images |
| Message | 31342 | Freeform text, announcements |
| Connection | 31343 | Connection requests |
| Circle | 31344 | Circle membership management |

---

## Architecture

### Domain Layer (`backend/src/1_domains/social/`)

Pure business logic - knows nothing about Nostr or HTTP.

```
1_domains/social/
├── entities/
│   ├── Post.mjs              # Content unit with author, body, attachments, visibility
│   ├── Author.mjs            # Resolved author: user, household, or external npub
│   ├── Connection.mjs        # Relationship between principals
│   └── Circle.mjs            # Named group of connections
│
├── value-objects/
│   ├── Visibility.mjs        # Enum: private | household | circle | connections | public
│   ├── PostType.mjs          # activity | media | photo | fitness | recipe | message
│   ├── Attachment.mjs        # Reference to media (photo, workout data, recipe)
│   └── Attribution.mjs       # { authorId, sourceDevice?, contextType? }
│
├── services/
│   ├── FeedService.mjs       # Build feeds for a principal (respects visibility + governance)
│   ├── PostFactory.mjs       # Create posts with proper author resolution
│   ├── VisibilityResolver.mjs # Given post + viewer, can they see it?
│   └── ConnectionService.mjs  # Manage circles, follows, blocks
│
└── policies/
    └── SharingPolicy.mjs     # Rules for auto-generation
```

### Adapter Layer (`backend/src/2_adapters/social/`)

Nostr fully abstracted here. Domain codes against `SocialNetworkPort`, not Nostr specifics.

```
2_adapters/social/
├── NostrAdapter.mjs          # Implements SocialNetworkPort
│   ├── connect(relays[])
│   ├── publish(post)         # Post → Nostr event, sign, encrypt, publish
│   ├── subscribe(filters)
│   ├── fetchHistory(since)
│   └── close()
│
├── nostr/
│   ├── EventBuilder.mjs      # Post → Nostr event (NIP-44 encryption)
│   ├── EventParser.mjs       # Nostr event → Post (decrypt, validate badge)
│   ├── RelayPool.mjs         # Manage relay connections
│   ├── KeyManager.mjs        # Household nsec, signing operations
│   └── kinds.mjs             # Event kind constants
│
├── ports/
│   └── SocialNetworkPort.mjs # Interface domain codes against
│
└── LocalAdapter.mjs          # Null adapter for household-only posts
```

### Application Layer (`backend/src/3_applications/social/`)

Orchestrates use cases, wires domain to adapters.

```
3_applications/social/
├── SocialOrchestrator.mjs    # Main entry point
│   ├── createPost(author, content, visibility, attachments)
│   ├── getFeed(principal, filters)
│   ├── getConnections(principal)
│   ├── requestConnection(fromPrincipal, toPubkey)
│   └── updateSharingPolicy(principal, policy)
│
├── sync/
│   ├── OutboundSync.mjs      # Local posts → Nostr (if visibility allows)
│   ├── InboundSync.mjs       # Nostr → local storage
│   └── SyncScheduler.mjs     # Manage sync frequency, retries
│
├── automation/
│   ├── ActivityWatcher.mjs   # Listen to internal events
│   ├── PostGenerator.mjs     # Apply SharingPolicy to auto-create posts
│   └── AuthorResolver.mjs    # Attribution chain implementation
│
├── integration/
│   ├── GatekeeperBridge.mjs  # Visibility permissions, content filtering
│   ├── MediaBridge.mjs       # Resolve attachments from media adapters
│   └── LicensingBridge.mjs   # Attach badge certificate to outbound posts
│
└── ports/
    └── SocialEventEmitter.mjs # Emit events for frontend WebSocket
```

### API Layer (`backend/src/4_api/v1/social/`)

REST endpoints plus WebSocket via EventBus.

```
4_api/v1/social/
├── posts.mjs
│   ├── GET    /posts             # Get feed
│   ├── POST   /posts             # Create post
│   ├── GET    /posts/:id
│   ├── PATCH  /posts/:id         # Edit (own posts, within time window)
│   └── DELETE /posts/:id
│
├── connections.mjs
│   ├── GET    /connections
│   ├── POST   /connections       # Request connection
│   ├── PATCH  /connections/:id   # Accept, reject, block
│   ├── DELETE /connections/:id
│   ├── GET    /circles
│   ├── POST   /circles
│   └── PATCH  /circles/:id/members
│
├── policies.mjs
│   ├── GET    /sharing-policies
│   └── PUT    /sharing-policies
│
└── sync.mjs
    ├── POST   /sync/push
    └── POST   /sync/pull
```

### EventBus Integration (`backend/src/0_system/eventbus/`)

```
0_system/eventbus/
└── adapters/
    └── SocialEventAdapter.mjs
```

**Events emitted:**

| Event | Payload | Trigger |
|-------|---------|---------|
| `social:post:created` | `{ post, author }` | New post (local or incoming) |
| `social:post:updated` | `{ post }` | Post edited |
| `social:post:deleted` | `{ postId }` | Post removed |
| `social:connection:request` | `{ from, to }` | Incoming request |
| `social:connection:accepted` | `{ connection }` | Connection confirmed |
| `social:sync:status` | `{ pending, lastSync }` | Sync health |

Frontend subscribes to `social:feed:{householdId}` topic via existing WebSocket.

### Frontend Module (`frontend/src/modules/Social/`)

```
frontend/src/modules/Social/
├── Social.jsx
├── Social.scss
│
├── context/
│   └── SocialContext.jsx
│
├── components/
│   ├── Feed/
│   │   ├── Feed.jsx
│   │   ├── FeedFilters.jsx
│   │   └── FeedEmpty.jsx
│   │
│   ├── Post/
│   │   ├── PostCard.jsx
│   │   ├── PostComposer.jsx
│   │   ├── PostActions.jsx
│   │   └── PostAttachment.jsx
│   │
│   ├── Author/
│   │   ├── AuthorBadge.jsx       # Avatar + name + licensing badge
│   │   └── AuthorResolver.jsx
│   │
│   ├── Connections/
│   │   ├── ConnectionList.jsx
│   │   ├── ConnectionRequest.jsx
│   │   ├── CircleManager.jsx
│   │   └── AddConnection.jsx
│   │
│   └── Settings/
│       ├── SharingPolicies.jsx
│       └── VisibilityDefaults.jsx
│
└── hooks/
    ├── useFeed.js
    ├── useConnections.js
    ├── useSocialSocket.js
    └── usePostComposer.js
```

---

## Gatekeeper Integration

### Outbound (Posting)

```
User/System creates post
        │
        ▼
Gatekeeper.evaluate(principal, 'social:publish', resource)
        │
Checks:
• Can this user post this content type?
• Can this content be shared at this visibility level?
• Time-based restrictions (kids can't post after bedtime)?
• Content filtering (no governed content to external)?
        │
        ▼
Allow → Post created    Deny → Blocked with reason
```

### Inbound (Viewing Feed)

```
FeedService.getFeed(principal)
        │
        ▼
For each post, VisibilityResolver checks:
1. Base visibility (private/household/circle/etc)
2. Gatekeeper.evaluate(viewer, 'social:view', post)
   • Age-appropriate content filtering
   • Device-level restrictions
   • Time-based restrictions
        │
        ▼
Filtered feed returned
```

### Policy Configuration Example

```yaml
# data/household/apps/gatekeeper/config.yml

policies:
  child-social-access:
    statements:
      - effect: allow
        actions: [social:view]
        resources: [social:post:*]
        conditions:
          visibility: [household]
          curfew: { after: "06:00", before: "21:00" }

      - effect: allow
        actions: [social:publish]
        resources: [social:post:*]
        conditions:
          visibility: [household]

      - effect: deny
        actions: [social:publish]
        resources: [social:post:*]
        conditions:
          visibility: [circle, connections, public]

  adult-social-access:
    statements:
      - effect: allow
        actions: [social:view, social:publish]
        resources: [social:post:*]

      - effect: deny
        actions: [social:publish]
        resources: [social:post:*]
        conditions:
          content_labels: [adult, sensitive]
          visibility: [circle, connections, public]
```

**Key principle:** External visibility requires explicit policy allowance. Default-deny for anything leaving the household.

---

## Data Model

### YAML Configuration

```
data/household/apps/social/
├── config.yml                # Module settings, relay list
├── connections/
│   ├── index.yml             # Connection registry
│   └── circles.yml           # Circle definitions
└── policies/
    └── sharing.yml           # Auto-share rules
```

**Connection structure:**

```yaml
connections:
  - id: "conn_abc123"
    npub: "npub1cousin..."
    alias: "Sarah's Family"
    status: mutual              # pending_out | pending_in | mutual | blocked
    household_name: "The Smith Home"
    circles: [family, extended]
    added: 2026-01-15T10:30:00Z
    last_seen: 2026-02-01T14:22:00Z
```

### SQLite for Posts

```sql
CREATE TABLE posts (
    id TEXT PRIMARY KEY,
    nostr_id TEXT UNIQUE,
    author_type TEXT NOT NULL,        -- 'user' | 'household' | 'external'
    author_id TEXT NOT NULL,
    author_device TEXT,
    post_type TEXT NOT NULL,
    visibility TEXT NOT NULL,
    circles TEXT,                     -- JSON array
    content TEXT NOT NULL,            -- JSON
    context_type TEXT,
    context_ref TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER,
    deleted_at INTEGER,
    outbound_status TEXT,
    inbound_badge TEXT
);

CREATE INDEX idx_posts_feed ON posts(visibility, created_at DESC)
    WHERE deleted_at IS NULL;
CREATE INDEX idx_posts_author ON posts(author_type, author_id, created_at DESC);
CREATE INDEX idx_posts_outbound ON posts(outbound_status)
    WHERE outbound_status IS NOT NULL;

CREATE TABLE sync_state (
    relay_url TEXT PRIMARY KEY,
    last_event_time INTEGER,
    last_sync INTEGER,
    status TEXT
);
```

**Post content structure:**

```json
{
  "body": "Just finished a 45-minute cycling workout!",
  "attachments": [
    {
      "type": "fitness",
      "ref": "workout:2026-02-02:cycling",
      "summary": { "duration": 45, "calories": 380, "distance_km": 18.5 }
    }
  ],
  "context": {
    "generated": true,
    "policy": "auto-share-workouts",
    "approved_by": "user:kevin",
    "approved_at": 1738500000
  }
}
```

---

## Sync Model

**Eventually consistent** with low latency:

- Backend maintains persistent WebSocket to relay pool
- Subscriptions filter for events from known connections
- New events stored locally, emitted to EventBus
- Frontend receives via local WebSocket (near real-time)

**Outbound flow:**

1. Post created with external visibility
2. Gatekeeper approves
3. Stored locally with `outbound_status: pending`
4. OutboundSync picks up, encrypts, signs, publishes
5. Status updated to `sent` (or `failed` with retry)

**Inbound flow:**

1. Relay pushes event matching subscription
2. Validate signature and badge certificate
3. Decrypt content (NIP-44)
4. Store as Post
5. Emit `social:post:created` to EventBus

---

## Open Questions

1. **Relay selection:** Use public relays, recommend specific relays, or encourage families to run private relay?

2. **Photo storage:** Photos are large. Store thumbnails in events, full resolution via direct fetch? Or use relay-adjacent blob storage?

3. **Offline handling:** How long to queue outbound posts when network unavailable?

4. **Connection discovery:** How do cousins find each other's npubs initially? QR code? Manual exchange? NIP-05 identifiers?

5. **Moderation:** Can household admins delete incoming posts from feed? Block specific external users?

---

## Implementation Phases

### Phase 1: Local Social (Household Only)

- [ ] Social domain entities and services
- [ ] LocalAdapter (no Nostr)
- [ ] Posts API endpoints
- [ ] Basic frontend feed
- [ ] Gatekeeper integration for household visibility

### Phase 2: Connections & Circles

- [ ] Connection domain model
- [ ] Connections API
- [ ] Circle management UI
- [ ] Add connection flow (manual npub entry)

### Phase 3: Nostr Federation

- [ ] NostrAdapter implementation
- [ ] Key management (household nsec)
- [ ] OutboundSync and InboundSync
- [ ] Badge certificate attachment
- [ ] Relay configuration UI

### Phase 4: Auto-Generation

- [ ] ActivityWatcher for system events
- [ ] SharingPolicy configuration
- [ ] PostGenerator with approval flow
- [ ] Per-category settings UI

### Phase 5: Polish

- [ ] Real-time feed updates via WebSocket
- [ ] Connection request notifications
- [ ] Sync status indicators
- [ ] QR code connection sharing

---

## Changelog

| Date | Change |
|------|--------|
| 2026-02-02 | Initial design from brainstorming session |
