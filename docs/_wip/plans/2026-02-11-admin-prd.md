# DaylightStation Admin — Product Requirements Document

**Date:** 2026-02-11
**Status:** Draft

---

## 1. Overview

DaylightStation Admin is the management interface for the DaylightStation home automation platform. It provides configuration, monitoring, and content management across the system's domains: media, fitness, finance, home automation, messaging, scheduling, and more.

### 1.1 Roles

| Role | Access |
|------|--------|
| **Household Manager** | Content lists (full CRUD), household members & profiles, devices & screens, app configs, gratitude prompts |
| **System Admin** | Everything above, plus: integrations, scheduler jobs, system config, service health, credential status |

A user can hold both roles. Auth/login is out of scope for this PRD — we assume the role is known at render time. Non-manager users may be granted edit access to a subset of content lists (scoping TBD).

### 1.2 Design Principles

- **Hybrid editing:** Purpose-built forms for frequently-edited configs; generic YAML editor as fallback for everything else.
- **Smart defaults:** Only persist non-default values to keep YAML clean (established pattern from Content Lists).
- **No credential creation:** Credentials are pre-configured via YAML. Admin UI shows status and allows updates, not initial setup.
- **Mantine UI:** All components use Mantine (dark theme), consistent with the existing Content Lists implementation.

---

## 2. Navigation Structure

```
CONTENT
  Lists
    Menus                              [existing]
    Watchlists                         [existing]
    Programs                           [existing]

APPS
  Fitness                              [purpose-built form]
  Finance                              [purpose-built form]
  Gratitude                            [purpose-built form]
  Shopping                             [purpose-built form]
  (others)                             [YAML editor fallback]

HOUSEHOLD
  Members                              [purpose-built form]
  Devices                              [purpose-built form]

SYSTEM                                 [system admin only]
  Integrations                         [purpose-built + status]
  Scheduler                            [full CRUD]
  Config                               [generic YAML editor]
```

**Route pattern:** `/admin/{section}/{subsection}/:params`

---

## 3. Content Lists (Existing)

> Fully implemented. Documented here as baseline and quality reference for new sections.

### 3.1 Routes

- `/admin/content/lists/:type` — Index view (menus, watchlists, programs)
- `/admin/content/lists/:type/:name` — List editor

### 3.2 Index View

- Grid of list cards grouped by custom groups (`metadata.group`)
- Each card: icon (Tabler), title, description, active/inactive badge, item count
- "Create List" modal

### 3.3 List Editor

- Table with inline editing, drag-and-drop reordering (dnd-kit)
- Collapsible sections with headers, per-section settings
- Empty row at bottom for quick item creation
- Search/filter within list

### 3.4 Item Editing

**Simple mode:** Label, input (ContentSearchCombobox), action, section, active toggle, image picker.

**Full mode** (accordion categories):
- **Identity:** Label, input, action, active, group, image
- **Playback:** Shuffle, continuous, loop, fixed order, volume, playback rate
- **Scheduling:** Days (presets: Weekdays/Weekend/MWF/TTh), snooze, wait-until date
- **Display:** Shader, composite, playable
- **Progress** (watchlists only): Progress %, watched flag with override toggle
- **Custom Fields:** Arbitrary key-value pairs

### 3.5 Content Search (ContentSearchCombobox)

- **Search mode:** Backend search across all content sources
- **Browse mode:** Navigate parent/child hierarchy with breadcrumbs
- **Keyboard navigation:** Arrow keys, right to drill in, left to go up, enter to select
- **Siblings caching:** Preloads nearby items for instant navigation
- **Visual feedback:** Shimmer loading, source/type badges, item counts, unresolved content warnings

### 3.6 Section Management

- Add/delete/reorder/split sections
- Per-section settings: title, shuffle, continuous, fixed order, days, limit, priority, active, hold
- Single anonymous section hides its header (clean UI for simple lists)

### 3.7 Image Management

- Upload (drag-and-drop, max 5MB JPEG/PNG/WebP)
- Browse uploaded images with in-use indicators
- URL paste, Ctrl+V paste, drag URL from browser
- Inherited vs custom thumbnail indicator with "remove override" button

### 3.8 Config Indicators

Visual badges on item rows showing active non-default settings: shuffle, continuous, loop, fixed order, volume, speed, days, snooze, delay, shader, composite. Top 2 icons shown + "+N" overflow. Clickable to open full editor.

### 3.9 Progress Display (Watchlists)

- Green checkmark for watched items
- Progress bar + percentage for in-progress items
- Tracked automatically via media_memory

### 3.10 Backend API

Base: `/api/v1/admin/content/lists`

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/lists` | GET | Overview of all types with counts |
| `/lists/:type` | GET | All lists of a type |
| `/lists/:type` | POST | Create new list |
| `/lists/:type/:name` | GET | Get list sections + metadata |
| `/lists/:type/:name` | DELETE | Delete list |
| `/lists/:type/:name/settings` | PUT | Update list metadata |
| `/lists/:type/:name` | PUT | Reorder items |
| `/lists/:type/:name/items` | POST | Add item |
| `/lists/:type/:name/items/:index` | PUT | Update item |
| `/lists/:type/:name/items/:index` | DELETE | Delete item |
| `/lists/:type/:name/sections` | POST | Add section |
| `/lists/:type/:name/sections/:index` | PUT | Update section |
| `/lists/:type/:name/sections/:index` | DELETE | Delete section |
| `/lists/:type/:name/sections/reorder` | PUT | Reorder sections |
| `/lists/:type/:name/items/move` | PUT | Move item between sections |
| `/lists/:type/:name/sections/split` | POST | Split section at item |

Image endpoints: `/api/v1/admin/images/{upload,upload-url,list}`

---

## 4. Apps Config

**Route:** `/admin/apps/:appId`

**Pattern:** `AppConfigEditor` wrapper component loads the YAML config for the app and passes data to an app-specific form component. Apps without a purpose-built form fall back to the generic YAML editor (Section 9).

### 4.1 Fitness (`/admin/apps/fitness`)

**Data source:** `data/household/config/fitness.yml`

The most complex app config. Purpose-built form with tabbed or accordion sections:

#### 4.1.1 Device Mappings
- Table of ANT+ device IDs → user assignments
- Columns: Device ID, Assigned User (dropdown from household members + family/friends), Color label
- Separate tables for heart_rate and cadence devices
- Add/remove device rows

#### 4.1.2 Equipment
- CRUD table of equipment
- Fields: Name, ID (auto-generated from name), type (dropdown: stationary_bike, jumprope, punching_bag, step_platform, pull_up_bar, ab_roller), sensor config
- **Cadence-based** (bikes, rollers): Cadence sensor ID (dropdown from cadence devices), RPM thresholds (min/med/high/max)
- **BLE-based** (jump rope): BLE address, RPM thresholds
- **Vibration-based** (punching bag, step platform, pull-up bar): Location, MQTT topic, vibration thresholds (low/medium/high)

#### 4.1.3 Zones
- Ordered list editor (drag-and-drop or arrow keys)
- Fields per zone: Name, ID, min HR, color (color picker), coins awarded
- Default 5 zones: Cool → Active → Warm → Hot → On Fire

#### 4.1.4 Ambient LED
- Map each zone → Home Assistant scene name (dropdown or text input)
- Additional mappings: `off`, `fire_all` (when ALL users in fire zone)
- Throttle setting (ms between HA calls)

#### 4.1.5 Plex Integration
- Library ID (number input)
- Voice memo prompt threshold (seconds)
- Label configs: nomusic, governed, resumable (tag inputs)
- Governed types (multi-select: show, movie, etc.)
- Music playlists: name + Plex playlist ID (editable table)

#### 4.1.6 Nav Items
- Reorderable list of fitness navigation entries
- Fields: Name, icon, order, type (dropdown: plex_collection, plex_collection_group, plugin_direct, plugin_menu)
- Target config varies by type:
  - `plex_collection`: collection_id
  - `plex_collection_group`: collection_ids (multi-value)
  - `plugin_direct`: plugin_id
  - `plugin_menu`: menu_id (links to app_menus below)

#### 4.1.7 App Menus
- CRUD for sub-menus referenced by plugin_menu nav items
- Each menu: name, ID, items list (name + ID pairs)

#### 4.1.8 Governance
- Grace period (seconds)
- Superusers (multi-select from household members)
- Exemptions (multi-select from household members)
- **Challenge policies:** Nested editor for the `default` policy:
  - Base requirement (zone + participant rule)
  - Challenges table: interval range, min participants, selection type, selections list
  - Each selection: min_participants (number or "some"/"most"/"all"), label, zone, time_allowed, weight

#### 4.1.9 User Groups
- **Primary users:** Multi-select from household members (references to `data/users/` profiles)
- **Family:** Inline table — name, ID, birthyear, custom zone overrides (active/warm/hot/fire)
- **Friends:** Same format as family

#### 4.1.10 Settings
- `coin_time_unit_ms` (milliseconds)
- ANT+ device timeouts: inactive (ms), remove (ms)

### 4.2 Finance (`/admin/apps/finance`)

**Data source:** `data/household/config/finance.yml`

- Budget categories and monthly limits (editable table)
- Account balances (manual entry table)
- Buxfer sync: enabled toggle, last sync timestamp

### 4.3 Gratitude (`/admin/apps/gratitude`)

**Data source:** `data/household/config/gratitude.yml` + `data/household/common/gratitude/`

- **Enabled categories:** Checklist (gratitude, hopes, or custom)
- **Prompt management** per category:
  - Three-column view: Options (available) | Selections (used) | Discarded
  - Add new prompts to options
  - Move prompts between columns
  - Bulk import (textarea, one per line)
  - "Recycle all" button (move discarded → options)

### 4.4 Shopping (`/admin/apps/shopping`)

**Data source:** `data/household/config/harvesters.yml` (shopping section)

- Enabled toggle, timezone
- **Retailer CRUD table:**
  - Name, ID
  - Sender email addresses (tag input — add/remove)
  - Keywords (tag input)

### 4.5 Fallback: YAML Editor

Apps with config files but no purpose-built form (piano, keyboard, media-app, entropy, chatbots) open in the generic YAML editor described in Section 9.

---

## 5. Household — Members

**Route:** `/admin/household/members`

**Data sources:**
- `data/household/config/household.yml` — member list, head, per-app user assignments
- `data/users/{username}/profile.yml` — full user profile

### 5.1 Index View

Table of all household members:

| Column | Source |
|--------|--------|
| Display name | profile.yml `display_name` |
| Username | profile.yml `username` |
| Group label | profile.yml `group_label` (e.g. "Dad") |
| Type | profile.yml `type` (owner, family_member) |
| Head badge | household.yml `head` |
| App badges | Icons for apps the user participates in |

Actions: Add member, edit, remove from household.

### 5.2 Household Settings

Editable from a settings panel on the members page:
- Household name
- Head of household (dropdown from members)
- Per-app user assignments:
  - Fitness primary users (multi-select)
  - Gratitude enabled categories

### 5.3 Member Editor (`/admin/household/members/:username`)

Tabbed or accordion layout:

#### 5.3.1 Identity
- Display name, email, birthyear, type (dropdown), group (dropdown: primary/secondary), group_label (text)
- Username: read-only after creation

#### 5.3.2 Preferences
- Timezone (searchable dropdown)
- Units (imperial/metric)
- Language

#### 5.3.3 Identities
- Telegram: user_id, default_bot (dropdown from configured bots)
- Extensible for future platforms (Discord, etc.)

#### 5.3.4 App: Nutribot
- Calorie goals: min, max
- Macro goals: protein, carbs, fat, fiber, sodium

#### 5.3.5 App: Entropy Sources
Table editor for the user's entropy dashboard sources:

| Column | Description |
|--------|-------------|
| Name | Display name |
| Weight | Sort priority (higher = more important) |
| Icon | SVG filename |
| Metric | `days_since` or `count` |
| Data source | `lifelog` or `current` |
| Data path | Path within data source |
| URL | Link to external service |
| Thresholds | Green/yellow/red values |

Additional fields depending on metric type: `dateField`, `checkField`, `countField`, `itemName`, `listProperty`, `filter` (field/operator/value).

Add/remove/reorder rows.

#### 5.3.6 App: Fitness
- Heart rate zone overrides (or checkbox: "Use system defaults")
- Zone thresholds: active, warm, hot, fire (number inputs)

#### 5.3.7 App: Gratitude
- Favorite categories (multi-select)

### 5.4 Create Member

Modal: username (validated: lowercase, no spaces), display name, group.
Creates `data/users/{username}/profile.yml` with defaults and adds username to `household.yml` users list.

### 5.5 Remove Member

Confirmation dialog. Removes from `household.yml` users list and per-app user lists. Does NOT delete profile.yml (data preservation).

---

## 6. Household — Devices & Screens

**Route:** `/admin/household/devices`

**Data sources:**
- `data/household/config/devices.yml` — device registry
- `data/household/screens/{name}.yml` — per-screen widget layouts

### 6.1 Device Index

Card grid of registered devices:

| Field | Description |
|-------|-------------|
| Device name | Device key from YAML (e.g. "livingroom-tv") |
| Type | shield-tv, linux-pc, midi-keyboard |
| Displays | Count and names of displays |
| Content control | Provider type (fully-kiosk, websocket, none) |

Actions: Add device, edit, delete (with confirmation).

### 6.2 Device Editor (`/admin/household/devices/:deviceId`)

Form layout varies by device type:

#### 6.2.1 Shield TV Type
- **Display control** per display:
  - Provider: homeassistant
  - HA scripts: on, off, volume (entity ID pickers or text inputs)
  - State sensor entity ID
- **Content control:**
  - Provider: fully-kiosk
  - Host, port, auth_ref (reference to auth file)

#### 6.2.2 Linux PC Type
- **Display control** per display (same as Shield TV — on/off scripts per display)
- **OS control:**
  - Provider: ssh
  - Host, user, port
  - Shell commands: volume, mute, unmute, audio_device (template strings with `{level}`, `{device}`)
- **Content control:**
  - Provider: websocket
  - Topic name
- **Module hooks:**
  - Table of module_name → on_open / on_close HA script mappings

#### 6.2.3 MIDI Keyboard Type
- Extension path

#### 6.2.4 Create Device
Modal: device name (becomes YAML key), type (dropdown). Adds entry to `devices.yml`.

### 6.3 Screen Editor (`/admin/household/devices/:deviceId/screen` or `/admin/household/screens/:screenName`)

**Data source:** `data/household/screens/{name}.yml`

- **Screen metadata:** name, route, profile, input type
- **Layout config:** type (grid), columns, rows, gap
- **Widget grid editor:**
  - Visual grid showing widget placement
  - Each widget: row, col, rowspan, colspan, source (API endpoint or widget type), config object
  - Add/remove/reposition widgets
  - Drag-and-drop repositioning within grid (stretch goal)

---

## 7. System — Integrations

**Route:** `/admin/system/integrations`

> System Admin role required.

**Data sources:**
- `data/household/config/integrations.yml` — provider declarations
- `data/system/config/services.yml` — per-environment service URLs
- `data/household/auth/*.yml` — household-level credentials (status only)
- `data/system/auth/*.yml` — system-level credentials (status only)

### 7.1 Index View

Card grid of integrations grouped by category:

| Category | Providers |
|----------|-----------|
| Media | Plex |
| Gallery | Immich |
| Audiobooks | Audiobookshelf |
| Ebooks | Audiobookshelf, Komga |
| Home Automation | Home Assistant |
| AI | OpenAI |
| Finance | Buxfer |
| Messaging | Telegram (nutribot, journalist, homebot) |

Each card shows:
- Provider name + icon
- **Connection status badge:** Green (healthy), red (unreachable), gray (not configured)
- Service URL for current environment
- Last health check timestamp

### 7.2 Integration Detail (`/admin/system/integrations/:provider`)

- **Service URL:** Displayed per-environment from services.yml (read-only — edit via Config YAML editor)
- **Auth status:** Credentials present? Shows masked preview (e.g. "Token: ••••a1b2"). "Update" button to replace.
- **Test connection:** Button that calls a provider-specific health endpoint. Shows response time and result.
- **Household config:** Provider-specific settings from integrations.yml:
  - Plex: protocol, platform
  - Messaging: bot → platform assignments
- **Dependent services:** List of features/apps that use this integration

### 7.3 Connection Health

Background job (or on-demand) tests each integration:
- Plex: `GET /` with auth token
- Home Assistant: `GET /api/` with long-lived token
- Immich: `GET /api/server-info`
- Audiobookshelf: `GET /api/authorize`
- Buxfer: token validation endpoint

Results cached with timestamp, refreshed on page load or manual trigger.

---

## 8. System — Scheduler

**Route:** `/admin/system/scheduler`

> System Admin role required.

**Data sources:**
- `data/system/config/jobs.yml` — job definitions
- `data/system/state/cron-runtime.yml` — execution state

### 8.1 Index View

Table of all scheduled jobs:

| Column | Source |
|--------|--------|
| Status indicator | Runtime state: idle (gray), running (blue spinner), error (red), disabled (dim) |
| Job name | jobs.yml `name` |
| Schedule | Cron expression + human-readable label (e.g. "Every 10 min", "Daily at 3:00 AM") |
| Last run | cron-runtime.yml timestamp |
| Last result | Success (green check) / Error (red X) + duration |
| Dependencies | Job IDs this job depends on |
| Actions | Run Now, Enable/Disable toggle |

**Grouping by frequency band:**
- **Every 10 minutes:** Weather, Calendar, Todoist, Gmail
- **Hourly:** Withings, Strava, Last.fm, ClickUp, Foursquare, Budget
- **Daily:** Fresh Video, FitSync, Health, Letterboxd, Goodreads, GitHub, Reddit, Shopping, Archive Rotation, Media Memory Validator

### 8.2 Job Editor Modal

| Field | Type | Notes |
|-------|------|-------|
| Name | Text | Human-readable name |
| ID | Text | Read-only after creation, slug format |
| Module | Text | Module path (relative to backend) |
| Schedule | Text + helper | Cron expression with visual preview of next 5 run times |
| Window | Number | Jitter window in minutes (optional) |
| Dependencies | Multi-select | Other job IDs that must complete first |
| Enabled | Toggle | |

### 8.3 Job Detail (`/admin/system/scheduler/:jobId`)

- Job metadata (all fields from editor, read-only)
- **Execution history:** Table of last N runs:
  - Timestamp, duration, result (success/error), error message (expandable)
- **Manual trigger:** "Run Now" button with confirmation. Shows live status while running.
- **Dependency graph:** Visual indicator of upstream/downstream jobs (optional, stretch goal)

### 8.4 Create / Delete Job

- **Create:** Modal with all editor fields. ID auto-generated from name.
- **Delete:** Confirmation dialog. Warns if other jobs list this job as a dependency.

---

## 9. System — Config (YAML Fallback Editor)

**Route:** `/admin/system/config`

> System Admin role required.

### 9.1 File Browser

Tree view of editable config directories:

```
system/config/
  system.yml
  services.yml
  bots.yml
  adapters.yml
  jobs.yml
  logging.yml
  media.yml
  fitness.yml
  entropy.yml
  journalist.yml
  nutribot.yml
  archive.yml
  dev.yml
  testdata.yml

household/config/
  household.yml
  devices.yml
  integrations.yml
  fitness.yml
  finance.yml
  gratitude.yml
  harvesters.yml
  chatbots.yml
  content-prefixes.yml
  entropy.yml
  keyboard.yml
  media-app.yml
  piano.yml

household/auth/
  (file list only — masked contents)
```

Files that have a purpose-built editor (fitness, household, devices, integrations, jobs) show a "Open in editor" link that routes to the purpose-built page.

### 9.2 YAML Editor

- Syntax-highlighted YAML with line numbers
- **Validation:** Parses YAML on save, rejects invalid syntax with error position
- **Diff view:** Shows changes before save (before/after comparison)
- **Revert:** Undo all unsaved changes
- **Save:** Writes to disk after validation

### 9.3 Restrictions

- `system/auth/` files: **Not editable.** Status-only view (file exists? last modified?). Updated through integration detail views.
- `household/auth/` files: Same restriction.
- Read-only badge on files that have a purpose-built editor, with link to that editor.

---

## 10. Backend API (New Endpoints)

### 10.1 Household

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/household` | GET | Household metadata + member list |
| `/api/v1/admin/household` | PUT | Update household settings |
| `/api/v1/admin/household/members` | POST | Add member |
| `/api/v1/admin/household/members/:username` | GET | Full user profile |
| `/api/v1/admin/household/members/:username` | PUT | Update user profile |
| `/api/v1/admin/household/members/:username` | DELETE | Remove from household |

### 10.2 Devices & Screens

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/devices` | GET | All devices |
| `/api/v1/admin/devices` | POST | Create device |
| `/api/v1/admin/devices/:id` | GET | Device detail |
| `/api/v1/admin/devices/:id` | PUT | Update device |
| `/api/v1/admin/devices/:id` | DELETE | Delete device |
| `/api/v1/admin/screens` | GET | All screens |
| `/api/v1/admin/screens/:name` | GET | Screen layout |
| `/api/v1/admin/screens/:name` | PUT | Update screen layout |

### 10.3 App Config

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/apps` | GET | List apps with config status |
| `/api/v1/admin/apps/:appId/config` | GET | App config YAML (parsed) |
| `/api/v1/admin/apps/:appId/config` | PUT | Update app config |

### 10.4 Integrations

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/integrations` | GET | All integrations with status |
| `/api/v1/admin/integrations/:provider` | GET | Integration detail + health |
| `/api/v1/admin/integrations/:provider/test` | POST | Test connection |
| `/api/v1/admin/integrations/:provider/auth` | PUT | Update credentials |

### 10.5 Scheduler

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/scheduler/jobs` | GET | All jobs with runtime state |
| `/api/v1/admin/scheduler/jobs` | POST | Create job |
| `/api/v1/admin/scheduler/jobs/:id` | GET | Job detail + history |
| `/api/v1/admin/scheduler/jobs/:id` | PUT | Update job |
| `/api/v1/admin/scheduler/jobs/:id` | DELETE | Delete job |
| `/api/v1/admin/scheduler/jobs/:id/run` | POST | Trigger manual run |

### 10.6 Config Editor

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/admin/config/files` | GET | List editable config files |
| `/api/v1/admin/config/files/:path` | GET | Read file contents |
| `/api/v1/admin/config/files/:path` | PUT | Write file (with YAML validation) |

---

## 11. Shared Patterns

### 11.1 Form Save Behavior
- All forms use optimistic UI with error rollback
- Save button at bottom of form (not auto-save for config changes)
- Success toast on save, error toast with message on failure
- Unsaved changes indicator + "Discard" option

### 11.2 Confirmation Dialogs
All destructive actions (delete device, remove member, delete job) require confirmation with:
- Clear description of what will be deleted
- Impact statement (e.g. "2 other jobs depend on this one")
- Type-to-confirm for high-impact deletes (optional)

### 11.3 Loading States
- Skeleton/shimmer loaders for initial page load (established pattern from Content Lists)
- Button spinner for save/action operations
- Disable form inputs during save

### 11.4 Error Handling
- API errors display in toast notifications
- Form validation errors inline next to fields
- Network errors show retry option
- YAML parse errors show line/column position

### 11.5 Test IDs
All interactive elements get `data-testid` attributes for Playwright tests:
- Pattern: `{section}-{element}-{identifier}` (e.g. `member-edit-kckern`, `job-run-weather`)

---

## 12. Out of Scope

- **Authentication/login flow** — role is assumed known at render time
- **Multi-household switching** — single household for now
- **Real-time updates** (WebSocket push of config changes)
- **Audit log** (who changed what when)
- **Data browser** (viewing app data, state, history files)
- **Bot conversation history viewer**
- **Backup/restore UI**

These may be addressed in future PRDs.
